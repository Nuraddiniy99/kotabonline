<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Maktabah Hikada - Turats Reader</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:ital,wght@0,400;0,700;1,400&family=Scheherazade+New:wght@400;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* ========================================
           1. VARIABLES & THEME
        ======================================== */
        :root {
            --bg: #ffffff; /* White */
            --paper-bg: #fdfbf7; /* Cream old paper */
            --text-color: #000000; /* Black */
            --accent-gold: #d4af37; /* Gold */
            --accent-blue: #001f3f; /* Dark blue */
            
            /* Glassmorphism subtle */
            --glass-bg: rgba(253, 251, 247, 0.95);
            --glass-border: rgba(212, 175, 55, 0.3);
            --glass-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
            
            --font-main: 'Amiri', serif;
        }

        [data-theme="dark"] {
            --bg: #000000; /* Black */
            --paper-bg: #121212; /* Dark gray */
            --text-color: #ffffff; /* White */
            --accent-gold: #fbbf24; /* Brighter gold */
            --accent-blue: #add8e6; /* Modern light blue */
            --glass-bg: rgba(18, 18, 18, 0.95);
            --glass-border: rgba(173, 216, 230, 0.3); /* Light blue border */
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body {
            font-family: system-ui, -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text-color);
            height: 100vh;
            overflow: hidden;
            transition: background 0.3s, color 0.3s;
        }

        /* ========================================
           2. LAYOUT (Mobile First)
        ======================================== */
        .app-container {
            display: flex;
            height: 100vh;
            flex-direction: column;
        }

        /* HEADER */
        .header {
            height: 60px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 15px;
            background: var(--glass-bg);
            border-bottom: 1px solid var(--accent-gold);
            z-index: 100;
            position: relative;
            box-shadow: var(--glass-shadow);
        }

        .logo { 
            font-family: var(--font-main);
            font-weight: 700; 
            font-size: 1.4rem; 
            color: var(--accent-blue);
        }

        .header-actions { display: flex; align-items: center; gap: 15px; }
        .header-btn {
            background: none; border: none; font-size: 1.2rem;
            color: var(--text-color); cursor: pointer;
            transition: color 0.2s;
        }
        .header-btn:hover { color: var(--accent-gold); }

        /* SEARCH BAR IN HEADER (ANIMATED) */
        .search-container {
            position: absolute;
            left: 60px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            align-items: center;
            background: var(--paper-bg);
            border-radius: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
            width: 40px;
            height: 40px;
            transition: width 0.4s cubic-bezier(0.25, 1, 0.5, 1);
            border: 1px solid var(--accent-blue);
        }

        .search-container.active { width: 220px; }

        .search-btn-trigger {
            width: 40px; height: 40px;
            background: none; border: none;
            color: var(--accent-blue); font-size: 1rem;
            cursor: pointer; flex-shrink: 0;
            display: flex; justify-content: center; align-items: center;
        }

        .search-input-book {
            border: none; background: transparent;
            height: 100%; width: 100%;
            padding: 0 10px;
            font-family: var(--font-main);
            color: var(--text-color);
            opacity: 0; transition: opacity 0.3s;
        }
        .search-container.active .search-input-book { opacity: 1; }

        /* ========================================
           3. BOOK VIEWER (Clear, Professional, Elegant, Modern, No Slider/Flip)
        ======================================== */
        .main-viewer {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
            background: var(--bg);
        }

        .page-content {
            flex: 1;
            background: var(--paper-bg);
            border-radius: 8px;
            border: 1px solid var(--accent-gold);
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            padding: 20px;
            margin: 10px;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        /* Simplified Ornament for Elegance */
        .page-content::before {
            content: ''; position: absolute;
            top: 10px; right: 10px;
            width: 15px; height: 15px;
            border-top: 2px solid var(--accent-blue);
            border-right: 2px solid var(--accent-blue);
        }
        .page-content::after {
            content: ''; position: absolute;
            bottom: 10px; left: 10px;
            width: 15px; height: 15px;
            border-bottom: 2px solid var(--accent-blue);
            border-left: 2px solid var(--accent-blue);
        }

        /* Typography: Clear and Professional */
        .book-text {
            flex: 1;
            font-family: var(--font-main);
            font-size: 1.2rem;
            line-height: 2;
            text-align: justify;
            overflow-y: auto;
            direction: rtl;
            color: var(--text-color);
        }
        
        /* Support for complex styling */
        .book-text span, .book-text b, .book-text i { display: inline; } 

        .page-footer {
            margin-top: 15px;
            text-align: center;
            font-size: 0.9rem;
            color: var(--accent-blue);
            font-family: sans-serif;
            border-top: 1px solid var(--glass-border);
            padding-top: 10px;
        }

        /* ========================================
           4. SIDEBAR & LIBRARY LIST (Keep as is)
        ======================================== */
        .sidebar {
            position: fixed; top: 0; right: -100%;
            width: 100%; height: 100%;
            background: var(--paper-bg);
            z-index: 200;
            transition: right 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border-left: 2px solid var(--accent-gold);
            padding: 20px;
            display: flex; flex-direction: column;
            box-shadow: -5px 0 25px rgba(0,0,0,0.2);
        }
        .sidebar.active { right: 0; }

        .search-library-box {
            margin-bottom: 20px;
            position: relative;
        }
        .search-library-box input {
            width: 100%; padding: 12px 15px;
            border-radius: 8px;
            border: 1px solid var(--accent-gold);
            background: rgba(0,0,0,0.03);
            font-family: var(--font-main);
            color: var(--text-color);
        }

        .library-list { flex: 1; overflow-y: auto; }

        .book-item {
            padding: 15px;
            margin-bottom: 12px;
            border-radius: 8px;
            background: var(--glass-bg);
            border: 1px solid transparent;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }
        .book-item:hover { border-color: var(--accent-gold); transform: translateY(-2px); }
        .book-item.active { 
            background: rgba(0, 31, 63, 0.1); /* Dark blue tint */
            border-color: var(--accent-blue); 
        }
        .book-item h4 { font-family: var(--font-main); margin-bottom: 5px; color: var(--accent-blue); }
        .book-item p { font-size: 0.8rem; opacity: 0.7; }

        /* Overlay */
        .overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.5);
            z-index: 150; opacity: 0; pointer-events: none; transition: 0.3s;
            backdrop-filter: blur(2px);
        }
        .overlay.active { opacity: 1; pointer-events: auto; }

        /* ========================================
           5. CONTROLS
        ======================================== */
        .bottom-controls {
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            background: var(--glass-bg);
            padding: 10px;
            border-top: 1px solid var(--glass-border);
            box-shadow: 0 -5px 15px rgba(0,0,0,0.1);
            z-index: 90;
        }
        .nav-btn {
            background: var(--accent-blue); color: #fff;
            width: 40px; height: 40px; border-radius: 50%;
            border: none; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            font-size: 1rem;
            transition: transform 0.2s;
        }
        .nav-btn:active { transform: scale(0.9); }

        .page-number-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .page-number-input {
            width: 60px;
            padding: 5px;
            text-align: center;
            border: 1px solid var(--accent-blue);
            border-radius: 4px;
            background: var(--paper-bg);
            color: var(--text-color);
            font-family: var(--font-main);
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: var(--accent-gold); border-radius: 10px; }

        /* Highlight Search Result */
        mark { background-color: rgba(212, 175, 55, 0.3); color: inherit; padding: 2px; border-radius: 3px; }

        /* Media Queries for Mobile Optimization */
        @media (min-width: 601px) {
            .sidebar { width: 300px; right: -300px; }
            .sidebar.active { right: 0; }
        }

    </style>
</head>
<body>

    <div class="overlay" id="overlay" onclick="toggleSidebar()"></div>

    <div class="app-container">
        
        <header class="header">
            <div class="header-actions">
                <button class="header-btn" onclick="toggleSidebar()">
                    <i class="fa-solid fa-bars-staggered"></i>
                </button>
                <div class="search-container" id="searchContainer">
                    <button class="search-btn-trigger" onclick="toggleSearch()">
                        <i class="fa-solid fa-magnifying-glass"></i>
                    </button>
                    <input type="text" class="search-input-book" id="inBookSearch" placeholder="Cari teks di kitab ini..." onkeypress="handleSearchKeyPress(event)">
                </div>
            </div>

            <div class="logo">مكتبة حكادة</div>

            <div class="header-actions">
                <button class="header-btn" onclick="toggleTheme()">
                    <i class="fa-solid fa-moon" id="theme-icon"></i>
                </button>
            </div>
        </header>

        <main class="main-viewer" id="mainViewer">
            <div class="page-content">
                <div class="book-text" id="bookContent">
                    <div style="text-align: center; margin-top: 50%; transform: translateY(-50%); opacity: 0.6;">
                        <i class="fa-solid fa-book-open" style="font-size: 3rem; margin-bottom: 15px; color: var(--accent-gold);"></i>
                        <h3>اختر كتاباً للقراءة</h3>
                        <p>Silakan pilih kitab dari menu perpustakaan</p>
                    </div>
                </div>
                <div class="page-footer" id="pageFooter">
                    <span id="pageNumber">--</span>
                </div>
            </div>

            <div class="bottom-controls">
                <button class="nav-btn" onclick="prevPage()"><i class="fa-solid fa-chevron-left"></i></button>
                <div class="page-number-container">
                    <span>Halaman:</span>
                    <input type="number" class="page-number-input" id="pageInput" min="1" onkeypress="handlePageKeyPress(event)">
                </div>
                <button class="nav-btn" onclick="nextPage()"><i class="fa-solid fa-chevron-right"></i></button>
            </div>
        </main>
    </div>

    <aside class="sidebar" id="sidebar">
        <h3 style="margin-bottom: 20px; color: var(--accent-blue); text-align: center; border-bottom: 2px solid var(--accent-gold); padding-bottom: 10px;">
            <i class="fa-solid fa-swatchbook"></i> المكتبة
        </h3>
        
        <div class="search-library-box">
            <input type="text" id="librarySearchInput" placeholder="Cari nama kitab..." oninput="filterLibrary()">
            <i class="fa-solid fa-search" style="position: absolute; left: 15px; top: 12px; color: #999;"></i>
        </div>

        <div class="library-list" id="libraryList">
            </div>
        
        <div style="margin-top: 10px; font-size: 0.8rem; text-align: center; opacity: 0.5;">
            Maktabah Hikada v2.0
        </div>
    </aside>

    <script>
        // --- 1. STATE & DATA ---
        let books = [];
        let activeBook = null;
        let currentPage = 0;
        let normalizedPages = [];

        // --- 2. INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            loadBooks();
            
            // Theme Init
            const theme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', theme);
            updateThemeIcon(theme);

            // Gesture Init
            setupSwipe();

            // Update page input
            updatePageInput();
        });

        // --- 3. DATA LOADING (FETCH JSONL) ---
        async function loadBooks() {
            try {
                const response = await fetch('kotab.jsonl');
                if (!response.ok) throw new Error('File not found');
                
                const text = await response.text();
                books = text.trim().split('\n').map(line => {
                    try { return JSON.parse(line); } catch(e) { return null; }
                }).filter(b => b !== null);

            } catch (error) {
                console.warn("Gagal load kotab.jsonl, menggunakan data dummy/lokal untuk demo.", error);
                
                const localData = localStorage.getItem('hikada_books');
                if (localData) {
                    books = JSON.parse(localData);
                } else {
                    books = [
                        {
                            id: 1, title: "Safinatun Najah", author: "Syekh Salim bin Sumair",
                            pages: [
                                "<h2 style='color:var(--accent-blue); text-align:center;'>بسم الله الرحمن الرحيم</h2><br>Kalam adalah lafaz yang tersusun yang memberi faedah dengan bahasa Arab.",
                                "Fasal: Rukun Islam ada lima: Syahadat, Shalat, Zakat, Puasa, Haji.",
                                "Fasal: Rukun Iman ada enam: Iman kepada Allah, Malaikat, Kitab, Rasul, Hari Akhir, Qada Qadar."
                            ]
                        },
                        {
                            id: 2, title: "Al-Jurumiyah", author: "Ibnu Ajurrum",
                            pages: [
                                "<h2 style='text-align:center'>باب الكلام</h2><br> <span style='color:red; font-size:1.5rem;'>الكلام</span>: هو اللفظ المركب المفيد بالوضع.",
                                "Pembagian kata ada tiga: <b>Isim</b>, <b>Fi'il</b>, dan <b>Huruf</b> yang memiliki makna."
                            ]
                        }
                    ];
                }
            }
            
            renderLibrary();
        }

        // --- 4. LIBRARY FUNCTIONS ---
        function renderLibrary(filteredBooks = null) {
            const listContainer = document.getElementById('libraryList');
            listContainer.innerHTML = '';
            
            const dataToShow = filteredBooks || books;

            if (dataToShow.length === 0) {
                listContainer.innerHTML = '<p style="text-align:center; margin-top:20px; color:gray;">Kitab tidak ditemukan.</p>';
                return;
            }

            dataToShow.forEach(book => {
                const div = document.createElement('div');
                div.className = `book-item ${activeBook && activeBook.id === book.id ? 'active' : ''}`;
                div.onclick = () => openBook(book.id);
                div.innerHTML = `
                    <h4>${book.title}</h4>
                    <p><i class="fa-solid fa-user-pen"></i> ${book.author}</p>
                    <p style="position:absolute; bottom:15px; left:15px; font-size:0.7rem; background:var(--accent-gold); color:#fff; padding:2px 6px; border-radius:4px;">${book.pages.length} Hal</p>
                `;
                listContainer.appendChild(div);
            });
        }

        function filterLibrary() {
            const query = document.getElementById('librarySearchInput').value.toLowerCase();
            const filtered = books.filter(b => 
                b.title.toLowerCase().includes(query) || 
                b.author.toLowerCase().includes(query)
            );
            renderLibrary(filtered);
        }

        // --- 5. BOOK VIEWER LOGIC ---
        function openBook(id) {
            activeBook = books.find(b => b.id === id);
            if (!activeBook) return;

            // Pre-process normalized pages for efficient search
            normalizedPages = activeBook.pages.map(page => normalizeArabic(stripHtml(page)).toLowerCase());

            currentPage = 0;
            
            toggleSidebar(); // Close sidebar
            renderPageContent();
            renderLibrary(); // Re-render to highlight active
            updatePageInput();
        }

        function renderPageContent() {
            if (!activeBook) return;

            const contentDiv = document.getElementById('bookContent');
            const footerDiv = document.getElementById('pageNumber');

            // Reset Scroll
            contentDiv.scrollTop = 0;
            
            // Render HTML Complex
            contentDiv.innerHTML = activeBook.pages[currentPage];
            footerDiv.innerText = `${currentPage + 1} / ${activeBook.pages.length}`;
        }

        // --- 6. PAGE NAVIGATION (Direct, No Animation) ---
        function nextPage() {
            if (!activeBook || currentPage >= activeBook.pages.length - 1) return;
            currentPage++;
            renderPageContent();
            updatePageInput();
        }

        function prevPage() {
            if (!activeBook || currentPage <= 0) return;
            currentPage--;
            renderPageContent();
            updatePageInput();
        }

        function goToPage(pageNum) {
            if (!activeBook || pageNum < 1 || pageNum > activeBook.pages.length) return;
            currentPage = pageNum - 1;
            renderPageContent();
            updatePageInput();
        }

        function handlePageKeyPress(e) {
            if (e.key === 'Enter') {
                const input = document.getElementById('pageInput');
                const pageNum = parseInt(input.value);
                goToPage(pageNum);
            }
        }

        function updatePageInput() {
            const input = document.getElementById('pageInput');
            if (activeBook) {
                input.max = activeBook.pages.length;
                input.value = currentPage + 1;
            } else {
                input.value = '';
            }
        }

        // --- 7. SEARCH IN BOOK (Faster, Ignore Harakat, Efficient) ---
        function toggleSearch() {
            const container = document.getElementById('searchContainer');
            const input = document.getElementById('inBookSearch');
            container.classList.toggle('active');
            if (container.classList.contains('active')) {
                input.focus();
            }
        }

        function handleSearchKeyPress(e) {
            if (e.key === 'Enter') {
                searchInBook();
            }
        }

        function searchInBook() {
            if (!activeBook) return;
            const query = document.getElementById('inBookSearch').value.trim();
            if (!query) return;

            const normalizedQuery = normalizeArabic(query).toLowerCase();

            let foundIndex = -1;
            
            for (let i = currentPage + 1; i < normalizedPages.length; i++) {
                if (normalizedPages[i].includes(normalizedQuery)) {
                    foundIndex = i;
                    break;
                }
            }
            
            if (foundIndex === -1) {
                for (let i = 0; i <= currentPage; i++) {
                    if (normalizedPages[i].includes(normalizedQuery)) {
                        foundIndex = i;
                        break;
                    }
                }
            }

            if (foundIndex !== -1) {
                currentPage = foundIndex;
                renderPageContent();
                updatePageInput();
                highlightText(query);
            } else {
                alert('Teks tidak ditemukan dalam kitab ini.');
            }
        }

        function stripHtml(html) {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;
            return tempDiv.textContent || tempDiv.innerText || '';
        }

        function normalizeArabic(text) {
            return text.replace(/[\u0610-\u061A\u064B-\u065F\u06D6-\u06DC\u06DF-\u06E8\u06EA-\u06ED]/g, '');
        }

        function highlightText(query) {
            const contentDiv = document.getElementById('bookContent');
            const innerHTML = contentDiv.innerHTML;
            const regex = new RegExp(`(${query})`, 'gi');
            
            contentDiv.innerHTML = innerHTML.replace(regex, '<mark>$1</mark>');
        }

        // --- 8. UI HELPERS ---
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
            document.getElementById('overlay').classList.toggle('active');
        }

        function toggleTheme() {
            const current = document.documentElement.getAttribute('data-theme');
            const newTheme = current === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeIcon(newTheme);
        }

        function updateThemeIcon(theme) {
            const icon = document.getElementById('theme-icon');
            if (theme === 'dark') {
                icon.classList.remove('fa-moon');
                icon.classList.add('fa-sun');
            } else {
                icon.classList.remove('fa-sun');
                icon.classList.add('fa-moon');
            }
        }

        // --- 9. SWIPE GESTURE ---
        function setupSwipe() {
            const viewer = document.getElementById('mainViewer');
            let touchStartX = 0;
            let touchEndX = 0;

            viewer.addEventListener('touchstart', e => touchStartX = e.changedTouches[0].screenX, {passive: true});
            viewer.addEventListener('touchend', e => {
                touchEndX = e.changedTouches[0].screenX;
                handleSwipe();
            }, {passive: true});

            function handleSwipe() {
                const diff = touchStartX - touchEndX;
                if (Math.abs(diff) > 50) {
                    if (diff > 0) nextPage();
                    else prevPage();
                }
            }
        }
    </script>
</body>
</html>
